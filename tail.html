<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WeaveTXT – Neighbor Tail / Head</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: #222;
      --bg-card: #333;
      --bg-tile: #444;
      --bg-tile-empty: #2b2b2b;
      --bg-tile-selected: #3f3f3f;
      --accent: #ffb347;
      --accent-soft: #ffecb3;
      --accent-border: #ff9800;
      --text-main: #f5f5f5;
      --text-muted: #aaa;
      --text-soft: #ddd;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #2b3a4a 0, #111 55%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      margin: 0;
    }

    /* -------- Branding -------- */
    #brand {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .brand-weave {
      font-family: "Georgia", serif;
      font-size: clamp(22px, 5vw, 30px);
      font-weight: bold;
      letter-spacing: 0.03em;
    }

    .brand-txt {
      font-family: "Courier New", monospace;
      font-size: clamp(18px, 4.5vw, 24px);
      font-weight: bold;
      color: var(--accent);
      border-right: 2px solid var(--accent);
      padding-right: 4px;
      animation: caret-blink 0.9s step-end infinite;
      min-width: 3ch;
    }

    @keyframes caret-blink {
      0%, 100% { border-color: transparent; }
      50% { border-color: var(--accent); }
    }

    h1 {
      margin: 2px 0 0;
      font-size: clamp(20px, 5vw, 26px);
      text-align: center;
    }

    #subtitle {
      font-size: 12px;
      margin-top: 4px;
      margin-bottom: 14px;
      color: var(--text-muted);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    /* -------- Game Container -------- */
    #game-container {
      background: var(--bg-card);
      padding: 16px 14px 18px;
      border-radius: 10px;
      box-shadow: 0 0 18px rgba(0,0,0,0.55);
      max-width: 520px;
      width: 100%;
      border: 1px solid #414141;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    #points-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-soft);
    }

    #points { color: var(--accent); font-weight: 700; margin-left: 4px; }

    #puzzle-info {
      font-size: 11px;
      color: var(--text-muted);
      text-align: right;
    }

    /* -------- Word Rows -------- */
    #word-rows {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
      font-family: "Courier New", monospace;
      font-size: clamp(18px, 4.5vw, 22px);
    }

    .word-row {
      background: var(--bg-tile-empty);
      padding: 8px 12px;
      border-radius: 8px;
      letter-spacing: 3px;
      border: 1px solid #444;
    }

    /* -------- Controls -------- */
    #controls {
      margin-top: 4px;
      border-top: 1px solid #444;
      padding-top: 10px;
      font-size: 13px;
    }

    #guess-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #555;
      background: #252525;
      color: var(--text-main);
      font-size: 16px;
    }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 6px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: var(--accent);
      color: #222;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 110px;
      transition: 0.1s;
    }

    #message {
      min-height: 24px;
      font-size: 12px;
      text-align: center;
      margin-top: 2px;
      white-space: pre-line;
    }

    .msg-success { color: #9be59b; }
    .msg-error { color: #ff9d9d; }
    .msg-warning { color: var(--accent); }
    .msg-info { color: var(--accent-soft); }

    #footer {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #444;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    #footer a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

  </style>
</head>

<body>

<!-- BRAND -->
<div id="brand">
  <span class="brand-weave">Weave</span>
  <span class="brand-txt" id="brand-txt"></span>
</div>

<h1>Neighbor Tail / Head</h1>
<div id="subtitle">Find the shared affix</div>

<div id="game-container">

  <div id="top-bar">
    <div id="points-label">
      Points: <span id="points">15</span>
    </div>

    <div id="puzzle-info">
      <span id="puzzle-counter">Puzzle 1 / 7</span><br>
      <label style="font-size: 11px;">Level:
        <select id="level-select" style="font-size: 12px; padding: 2px 4px;"></select>
      </label>
    </div>
  </div>

  <p class="instructions">
    You see four related words, but only partial letters.<br>
    Your job is to guess the missing <strong>3-letter affix</strong>.
  </p>

  <div id="word-rows">
    <div class="word-row"></div>
    <div class="word-row"></div>
    <div class="word-row"></div>
    <div class="word-row"></div>
  </div>

  <div id="controls">
    <label>Type your 3-letter guess:</label>
    <input id="guess-input" type="text" maxlength="3" autocomplete="off" />

    <div class="button-row">
      <button id="submit-btn">Submit</button>
      <button id="reveal-btn">Reveal Letter</button>
      <button id="next-btn" disabled>Next</button>
    </div>

    <div id="message" class="msg-info"></div>
  </div>

  <div id="footer">
    More from WeaveTXT:
    <a href="https://www.weavetxt.com/index.html" target="_blank">Swap and Weave</a> ·
    <a href="https://www.weavetxt.com/solitaire.html" target="_blank">Weave Solitaire</a>
  </div>

</div>

<!-- STRICT DICTIONARY REQUIRED -->
<script src="valid-3-6.js"></script>

<script>
/* ——— TXT Animation ——— */
(function animateTXT(){
  const el = document.getElementById("brand-txt");
  const word = "TXT";
  let i = 0, fwd = true;
  function loop(){
    el.textContent = word.slice(0, i);
    if (fwd) { i++; if (i > word.length){ fwd = false; setTimeout(loop, 700); return; } }
    else { i--; if (i < 0){ fwd = true; setTimeout(loop, 500); return; } }
    setTimeout(loop, 100);
  }
  loop();
})();

/* ——— Game Data ——— */
const puzzles = [
  { name:"Tail – g s n c", mode:"tail", prefixes:["g","s","n","c"], suffix:"ame",
    words:["game","same","name","came"], hint:"Common everyday words." },

  { name:"Tail – f k b w", mode:"tail", prefixes:["f","k","b","w"], suffix:"ind",
    words:["find","kind","bind","wind"], hint:"All rhyme with 'find'." },

  { name:"Tail – b d p m", mode:"tail", prefixes:["b","d","p","m"], suffix:"ark",
    words:["bark","dark","park","mark"], hint:"Animal voice + conditions." },

  { name:"Head – swa _", mode:"head", prefix:"swa",
    endings:["n","p","b","y"], words:["swan","swap","swab","sway"], hint:"Bird / exchange / tool." }
];

let currentIndex = 0;
let points = 15;
let revealed = [false,false,false];
let gameOver = false;

/* ——— Strict Dictionary Loading ——— */
let WORD_SET = null;
let DICT_READY = false;

function initDictionary() {
  if (!Array.isArray(window.VALID_WORDS)) {
    alert("ERROR: valid-3-6.js not loaded. VALID_WORDS must exist.");
    DICT_READY = false;
    return false;
  }
  WORD_SET = new Set(window.VALID_WORDS.map(w => w.toUpperCase()));
  DICT_READY = true;
  return true;
}

// Attempt immediately
initDictionary();

/* ——— Elements ——— */
const pointsSpan = document.getElementById("points");
const wordRows = document.querySelectorAll(".word-row");
const guessInput = document.getElementById("guess-input");
const submitBtn = document.getElementById("submit-btn");
const revealBtn = document.getElementById("reveal-btn");
const nextBtn = document.getElementById("next-btn");
const messageDiv = document.getElementById("message");
const puzzleCounterSpan = document.getElementById("puzzle-counter");
const levelSelectEl = document.getElementById("level-select");

/* ——— Helpers ——— */
function setMessage(t, type="info"){
  messageDiv.textContent = t;
  messageDiv.className = "msg-" + type;
}

function getPuzzle(){ return puzzles[currentIndex]; }

function getAffix(p){
  return p.mode === "tail" ? p.suffix : p.prefix;
}

function updateRows(){
  const p = getPuzzle();
  const affix = getAffix(p);
  let chars = [];
  for (let i=0;i<3;i++){
    chars.push(revealed[i] ? affix[i] : "_");
  }
  const display = chars.join(" ");

  if (p.mode === "tail"){
    for (let i=0;i<4;i++){
      wordRows[i].textContent = p.prefixes[i] + " " + display;
    }
  } else {
    for (let i=0;i<4;i++){
      wordRows[i].textContent = display + " " + p.endings[i];
    }
  }
}

function updatePoints(){
  pointsSpan.textContent = points;
}

function endWin(guess, words){
  gameOver = true;
  revealed=[true,true,true];
  updateRows();
  setMessage(`Correct! Words: ${words.join(", ")}`, "success");
  submitBtn.disabled=true; revealBtn.disabled=true; nextBtn.disabled=false;
}

function endLose(){
  gameOver = true;
  const p = getPuzzle();
  const affix = getAffix(p).toUpperCase();
  revealed=[true,true,true];
  updateRows();
  setMessage(`You ran out of points.\nOne valid affix was "${affix}".`, "error");
  submitBtn.disabled=true; revealBtn.disabled=true; nextBtn.disabled=false;
}

function handleSubmit(){
  if (gameOver) return;
  if (!DICT_READY){ setMessage("Dictionary not loaded.", "error"); return; }

  const input = guessInput.value.trim().toLowerCase();
  if (input.length !== 3){ setMessage("Enter exactly 3 letters.", "warning"); return; }

  const p = getPuzzle();
  let candidates;

  if (p.mode === "tail"){
    candidates = p.prefixes.map(x => x + input);
  } else {
    candidates = p.endings.map(e => input + e);
  }

  const upper = candidates.map(w => w.toUpperCase());
  const allValid = upper.every(w => WORD_SET.has(w));

  if (allValid){
    endWin(input, upper);
    return;
  }

  points -= 5;
  updatePoints();

  if (points <=0){ endLose(); }
  else setMessage(`Wrong. -5 points. (${points} left)`, "error");
}

function handleReveal(){
  if (gameOver) return;
  if (!DICT_READY){ setMessage("Dictionary missing.", "error"); return; }

  const p = getPuzzle();
  const affix = getAffix(p);
  const unrevealed=[];
  for (let i=0;i<3;i++) if(!revealed[i]) unrevealed.push(i);

  if (unrevealed.length ===0){
    setMessage("All letters already revealed.", "warning");
    return;
  }

  points -=10;
  updatePoints();

  const idx = unrevealed[Math.floor(Math.random()*unrevealed.length)];
  revealed[idx]=true;
  updateRows();

  if (points<=0){
    endLose();
  } else {
    setMessage(`Revealed: letter ${idx+1} is "${affix[idx].toUpperCase(
