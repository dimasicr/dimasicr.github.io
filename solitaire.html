<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weave Solitaire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: #222;
      --bg-card: #333;
      --bg-tile: #444;
      --bg-tile-empty: #2b2b2b;
      --bg-tile-selected: #3f3f3f;
      --accent: #ffb347;
      --accent-soft: #ffecb3;
      --accent-border: #ff9800;
      --text-main: #f5f5f5;
      --text-muted: #aaa;
      --text-soft: #ddd;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #2b3a4a 0, #111 55%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      margin: 0;
    }

    /* -------- BRANDING -------- */
    #brand {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .brand-weave {
      font-family: "Georgia", serif;
      font-size: clamp(22px, 5vw, 30px);
      font-weight: bold;
      letter-spacing: 0.03em;
    }

    .brand-txt {
      font-family: "Courier New", monospace;
      font-size: clamp(18px, 4.5vw, 24px);
      font-weight: bold;
      color: var(--accent);
      border-right: 2px solid var(--accent);
      padding-right: 4px;
      animation: caret-blink 0.9s step-end infinite;
      min-width: 3ch;
    }

    @keyframes caret-blink {
      0%, 100% { border-color: transparent; }
      50% { border-color: var(--accent); }
    }

    h1 {
      margin: 2px 0 0;
      font-size: clamp(20px, 5vw, 26px);
      text-align: center;
    }

    #subtitle {
      font-size: 12px;
      margin-top: 4px;
      margin-bottom: 14px;
      color: var(--text-muted);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    #game-container {
      background: var(--bg-card);
      padding: 16px 14px 18px;
      border-radius: 10px;
      box-shadow: 0 0 18px rgba(0,0,0,0.55);
      max-width: 520px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #414141;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    #level-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-soft);
    }

    #level-select {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #252525;
      color: var(--text-main);
    }

    #board {
      display: grid;
      gap: 8px;
      margin-bottom: 14px;
      justify-content: center;
    }

    /* Tiles use aspect-ratio to be responsive */
    .tile {
      border-radius: 8px;
      background: var(--bg-tile);
      border: 2px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(20px, 5vw, 28px);
      font-weight: bold;
      text-transform: uppercase;
      user-select: none;
      transition: box-shadow 0.08s ease, background 0.1s, border-color 0.1s, opacity 0.1s, transform 0.07s ease;
      aspect-ratio: 1 / 1;
      min-width: 44px;
    }

    .tile.empty {
      background: var(--bg-tile-empty);
      border-color: #444;
      color: #555;
    }

    .tile.active {
      cursor: pointer;
      background: #505050;
      border-color: var(--accent-border);
    }

    .tile.active:hover {
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      transform: translateY(-1px);
    }

    .tile.selected {
      background: var(--bg-tile-selected);
      border-color: var(--accent);
      opacity: 0.55;
    }

    #panel {
      margin-top: 8px;
      border-top: 1px solid #444;
      padding-top: 10px;
      font-size: 13px;
    }

    #current-word-box {
      margin-bottom: 8px;
      text-align: center;
    }

    #current-word-label {
      font-weight: 600;
      margin-right: 4px;
    }

    #current-word {
      font-family: "Fira Mono", Menlo, Consolas, monospace;
      letter-spacing: 2px;
      font-size: 18px;
      vertical-align: middle;
      color: var(--accent-soft);
    }

    #current-word-tiles {
      margin-top: 6px;
      display: flex;
      justify-content: center;
      gap: 6px;
      min-height: 40px;
      flex-wrap: nowrap;
    }

    .word-tile {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      background: var(--bg-tile);
      border: 2px solid var(--accent-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      text-transform: uppercase;
      box-sizing: border-box;
      animation: pop-in 0.12s ease-out;
      color: var(--text-main);
    }

    @keyframes pop-in {
      from {
        transform: scale(0.7);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    #buttons {
      margin-bottom: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: var(--accent);
      color: #222;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
      transition: background 0.1s ease, transform 0.07s ease, box-shadow 0.07s ease;
      white-space: nowrap;
    }

    button:hover {
      background: #ffab2c;
      transform: translateY(-1px);
      box-shadow: 0 3px 9px rgba(0,0,0,0.6);
    }

    button:disabled {
      background: #555;
      color: #999;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    #message {
      min-height: 18px;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--accent-soft);
      text-align: center;
    }

    #found-words-title {
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 4px;
      color: var(--text-soft);
      text-align: center;
    }

    #found-words {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    #found-words li {
      padding: 2px 7px;
      border-radius: 999px;
      background: #2f2f2f;
      border: 1px solid #555;
      font-family: "Fira Mono", Menlo, Consolas, monospace;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-main);
    }

    #hint {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
      text-align: left;
    }

    #hint strong {
      color: var(--accent-soft);
    }

    /* Footer */
    #footer {
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #444;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    #footer a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    #footer a:hover {
      text-decoration: underline;
    }

    /* Mobile tweaks */
    @media (max-width: 480px) {
      #game-container {
        padding: 14px 10px 16px;
      }
      #top-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      #hint {
        font-size: 10.5px;
      }
    }
  </style>
</head>
<body>
  <!-- BRAND -->
  <div id="brand">
    <span class="brand-weave">Weave</span>
    <span class="brand-txt" id="brand-txt"></span>
  </div>

  <h1>Weave Solitaire</h1>
  <div id="subtitle">Clear the board using only the bottom letters</div>

  <div id="game-container">
    <div id="top-bar">
      <div id="level-title"></div>
      <div>
        <label for="level-select" style="font-size:13px;margin-right:4px;">Level:</label>
        <select id="level-select"></select>
      </div>
    </div>

    <div id="board"></div>

    <div id="panel">
      <div id="current-word-box">
        <span id="current-word-label">Current word:</span>
        <span id="current-word"></span>
        <div id="current-word-tiles"></div>
      </div>

      <div id="buttons">
        <button id="submit-word-btn">Submit word</button>
        <button id="clear-word-btn">Clear selection</button>
        <button id="reset-level-btn">Reset level</button>
      </div>

      <div id="message"></div>

      <div id="found-words-title">Found words:</div>
      <ul id="found-words"></ul>

      <div id="hint">
        Rules:<br />
        • You may only click the <strong>bottom-most remaining letter</strong> of each column.<br />
        • Each letter you click is appended to the word row at the bottom.<br />
        • On an <strong>N×N</strong> board, only <strong>N-letter</strong> words are accepted (3×3 → 3 letters, 4×4 → 4 letters, 5×5 → 5 letters, etc.).<br />
        • Words are checked against the dictionary (<code>VALID_WORDS</code>, uppercase).<br />
        • Selected tiles appear empty in the grid and show up below, chained to form the word.<br />
        • Accepted words remove tiles permanently. Clear all tiles to win.
      </div>
    </div>

    <!-- FOOTER LINKS TO OTHER GAME -->
    <div id="footer">
      More from WeaveTXT:
      <a href="https://www.weavetxt.com/index.html" target="_blank" rel="noopener noreferrer">
        Swap and Weave
      </a>
            <a href="https://www.weavetxt.com/tail.html" target="_blank" rel="noopener noreferrer">
        Neighbour Tail
      </a>
    </div>
  </div>

  <!-- Dictionary: must define const VALID_WORDS = ["CAT","DOG",...] in UPPERCASE -->
  <script src="valid-3-6.js"></script>

  <script>
    /* --------- LOOPING TXT ANIMATION --------- */
    (function animateTXT(){
      const el = document.getElementById("brand-txt");
      const word = "TXT";
      let i = 0;
      let forward = true;

      function loop(){
        el.textContent = word.slice(0, i);

        if(forward){
          i++;
          if(i > word.length){
            forward = false;
            setTimeout(loop, 900);
            return;
          }
        } else {
          i--;
          if(i < 0){
            forward = true;
            setTimeout(loop, 600);
            return;
          }
        }
        setTimeout(loop, 120);
      }

      loop();
    })();

    // Optional safety check
    if (typeof VALID_WORDS === "undefined") {
      console.error("VALID_WORDS is not defined. Make sure valid-3-6.js is loaded.");
      alert("Error: valid-3-6.js not loaded or VALID_WORDS not defined.");
    }

    // LEVEL CONFIG (letters only; validity comes from VALID_WORDS)
    const levels = [
      {
        name: "Level 1 – 3×3",
        grid: [
          ["R","U","N"],
          ["T","I","F"],
          ["C","A","S"]
        ]
      },
      {
        name: "Level 2 – 4×4",
        grid: [
          ["I","N","G","S"],
          ["D","K","T","A"],
          ["I","U","R","P"],
          ["F","O","B","R"]
        ]
      },
      {
        name: "Level 3 – 5×5",
        grid: [
          ["H","T","N","D","M"],
          ["O","U","W","U","N"],
          ["E","T","O","S","O"],
          ["Z","U","L","C","L"],
          ["T","R","G","S","A"]
        ]
      }
    ];

    // GAME STATE
    let currentLevelIndex = 0;
    let board = [];         // 2D array of letters or null
    let selectionPath = []; // [{row, col, letter}]
    let foundWords = [];    // stored as UPPERCASE
    let gameOver = false;

    // DOM
    const levelTitleEl = document.getElementById("level-title");
    const levelSelectEl = document.getElementById("level-select");
    const boardEl = document.getElementById("board");
    const currentWordEl = document.getElementById("current-word");
    const currentWordTilesEl = document.getElementById("current-word-tiles");
    const messageEl = document.getElementById("message");
    const foundWordsEl = document.getElementById("found-words");
    const submitBtn = document.getElementById("submit-word-btn");
    const clearBtn = document.getElementById("clear-word-btn");
    const resetBtn = document.getElementById("reset-level-btn");

    // Populate level selector
    function initLevelSelect() {
      levelSelectEl.innerHTML = "";
      levels.forEach((lvl, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = lvl.name;
        levelSelectEl.appendChild(opt);
      });
      levelSelectEl.value = currentLevelIndex;
    }

    levelSelectEl.addEventListener("change", () => {
      const idx = parseInt(levelSelectEl.value, 10);
      initLevel(idx);
    });

    // INIT LEVEL
    function initLevel(index) {
      const level = levels[index];
      currentLevelIndex = index;
      gameOver = false;
      selectionPath = [];
      foundWords = [];

      // deep copy grid into board
      board = level.grid.map(row => row.slice());

      levelTitleEl.textContent = level.name;
      levelSelectEl.value = index.toString();
      renderBoard();
      renderCurrentWord();
      renderFoundWords();
      setMessage("Tap the bottom letters of each column to build a word.");
      updateButtons();
    }

    // ACTIVE CELLS = bottom-most non-null, non-selected in each column
    function computeActiveCells() {
      const rows = board.length;
      const cols = board[0].length;
      const activeSet = new Set();

      function isSelected(r, c) {
        return selectionPath.some(p => p.row === r && p.col === c);
      }

      for (let c = 0; c < cols; c++) {
        for (let r = rows - 1; r >= 0; r--) {
          if (board[r][c] !== null && !isSelected(r, c)) {
            activeSet.add(r + "," + c);
            break;
          }
        }
      }

      return activeSet;
    }

    // RENDER BOARD
    function renderBoard() {
      const rows = board.length;
      const cols = board[0].length;
      const activeSet = computeActiveCells();

      boardEl.style.gridTemplateColumns = `repeat(${cols}, minmax(44px, 1fr))`;
      boardEl.innerHTML = "";

      function isSelected(r, c) {
        return selectionPath.some(p => p.row === r && p.col === c);
      }

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const tile = document.createElement("div");
          const letter = board[r][c];
          const key = r + "," + c;
          const selected = isSelected(r, c);
          const isActive = activeSet.has(key);

          if (letter === null) {
            tile.className = "tile empty";
            tile.textContent = "";
          } else {
            tile.className = "tile";
            if (selected) tile.classList.add("selected");
            else if (isActive) tile.classList.add("active");

            // If selected, we hide the letter in the grid to simulate "taken out"
            tile.textContent = selected ? "" : letter;

            if (!gameOver && isActive && !selected) {
              tile.addEventListener("click", () => onTileClick(r, c));
            }
          }

          boardEl.appendChild(tile);
        }
      }
    }

    // HANDLE TILE CLICK
    function onTileClick(row, col) {
      if (gameOver) return;

      const activeSet = computeActiveCells();
      const key = row + "," + col;

      if (!activeSet.has(key)) {
        setMessage("You can only use the bottom-most remaining letter of each column.");
        return;
      }

      const letter = board[row][col];
      selectionPath.push({ row, col, letter });
      renderBoard();
      renderCurrentWord();
      setMessage(`Added "${letter}" to the word.`);
    }

    // RENDER CURRENT WORD & WORD TILES
    function renderCurrentWord() {
      const word = selectionPath.map(p => p.letter).join("");
      currentWordEl.textContent = word;

      currentWordTilesEl.innerHTML = "";
      for (const p of selectionPath) {
        const t = document.createElement("div");
        t.className = "word-tile";
        t.textContent = p.letter;
        currentWordTilesEl.appendChild(t);
      }
    }

    // RENDER FOUND WORDS
    function renderFoundWords() {
      foundWordsEl.innerHTML = "";
      if (foundWords.length === 0) return;

      for (const w of foundWords) {
        const li = document.createElement("li");
        li.textContent = w;
        foundWordsEl.appendChild(li);
      }
    }

    function setMessage(text) {
      messageEl.textContent = text || "";
    }

    function updateButtons() {
      submitBtn.disabled = gameOver;
      clearBtn.disabled = gameOver;
      resetBtn.disabled = false;
    }

    // CLEAR SELECTION (put letters back visually)
    function clearSelection() {
      selectionPath = [];
      renderBoard();
      renderCurrentWord();
      setMessage("Selection cleared.");
    }

    // CHECK BOARD CLEARED
    function isBoardCleared() {
      for (let r = 0; r < board.length; r++) {
        for (let c = 0; c < board[0].length; c++) {
          if (board[r][c] !== null) return false;
        }
      }
      return true;
    }

    // SUBMIT WORD – uses VALID_WORDS in UPPERCASE and enforces length = board size
    function submitWord() {
      if (gameOver) return;

      if (selectionPath.length === 0) {
        setMessage("Select some letters first.");
        return;
      }

      const raw = selectionPath.map(p => p.letter).join("");
      const wordUpper = raw.toUpperCase();

      // required length: number of columns (since it's N×N)
      const requiredLength = board[0].length;

      if (wordUpper.length !== requiredLength) {
        setMessage(`"${wordUpper}" must be exactly ${requiredLength} letters long on this level.`);
        selectionPath = [];
        renderBoard();
        renderCurrentWord();
        return;
      }

      // check dictionary (VALID_WORDS is all UPPERCASE)
      if (!Array.isArray(VALID_WORDS) || !VALID_WORDS.includes(wordUpper)) {
        setMessage(`"${wordUpper}" is not a valid English word.`);
        selectionPath = [];
        renderBoard();
        renderCurrentWord();
        return;
      }

      // prevent reusing the same word
      if (foundWords.includes(wordUpper)) {
        setMessage(`"${wordUpper}" already used. Try another word.`);
        selectionPath = [];
        renderBoard();
        renderCurrentWord();
        return;
      }

      // remove tiles permanently from the board
      for (const p of selectionPath) {
        board[p.row][p.col] = null;
      }
      foundWords.push(wordUpper);
      selectionPath = [];

      renderBoard();
      renderCurrentWord();
      renderFoundWords();

      if (isBoardCleared()) {
        gameOver = true;
        setMessage(`Great! You cleared all tiles with: ${foundWords.join(", ")}.`);
        updateButtons();
      } else {
        setMessage(`Accepted "${wordUpper}". Keep weaving!`);
      }
    }

    // BUTTON EVENTS
    submitBtn.addEventListener("click", submitWord);
    clearBtn.addEventListener("click", clearSelection);
    resetBtn.addEventListener("click", () => initLevel(currentLevelIndex));

    // START
    initLevelSelect();
    initLevel(0);
  </script>
</body>
</html>
