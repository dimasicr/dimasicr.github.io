<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-C3LDF2V8MF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-C3LDF2V8MF');
  </script>

  <meta charset="UTF-8" />
  <title>WeaveTXT – Word Tower</title>
  <link rel="icon" href="logo.svg" type="image/svg+xml">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --bg-main: #222;
      --bg-card: #333;
      --bg-tile: #444;
      --bg-tile-empty: #2b2b2b;
      --bg-tile-selected: #3f3f3f;
      --accent: #ffb347;
      --accent-soft: #ffecb3;
      --accent-border: #ff9800;
      --text-main: #f5f5f5;
      --text-muted: #aaa;
      --text-soft: #ddd;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #2b3a4a 0, #111 55%);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px;
      margin: 0;
    }

    /* -------- BRANDING -------- */
    #brand {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .brand-weave {
      font-family: "Georgia", serif;
      font-size: clamp(22px, 5vw, 30px);
      font-weight: bold;
      letter-spacing: 0.03em;
    }

    .brand-txt {
      font-family: "Courier New", monospace;
      font-size: clamp(18px, 4.5vw, 24px);
      font-weight: bold;
      color: var(--accent);
      border-right: 2px solid var(--accent);
      padding-right: 4px;
      animation: caret-blink 0.9s step-end infinite;
      min-width: 3ch;
    }

    @keyframes caret-blink {
      0%, 100% { border-color: transparent; }
      50% { border-color: var(--accent); }
    }

    h1 {
      margin: 2px 0 0;
      font-size: clamp(20px, 5vw, 26px);
      text-align: center;
    }

    #subtitle {
      font-size: 12px;
      margin-top: 4px;
      margin-bottom: 10px;
      color: var(--text-muted);
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    h4 {
      margin: 2px 0 10px;
      font-size: 11px;
      font-weight: normal;
      color: var(--text-muted);
    }

    #game-container {
      background: var(--bg-card);
      padding: 16px 14px 18px;
      border-radius: 10px;
      box-shadow: 0 0 18px rgba(0,0,0,0.55);
      max-width: 480px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #414141;
    }

    /* -------- TOP BAR -------- */
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      font-size: 13px;
    }

    #top-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    #tower-word-label {
      font-weight: 600;
      color: var(--text-soft);
    }

    #floor-info {
      font-size: 12px;
      color: var(--text-soft);
    }

    #floor-info strong {
      color: var(--accent-soft);
    }

    #top-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      font-size: 11px;
    }

    #level-select {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #252525;
      color: var(--text-main);
    }

    #time-display {
      margin-top: 4px;
      font-size: 11px;
      color: var(--accent-soft);
    }

    /* -------- TOWER BOARD -------- */
    #tower {
      display: grid;
      gap: 3px;
      margin-bottom: 10px;
      justify-content: center;
      grid-template-columns: repeat(5, minmax(22px, 1fr));
    }

    .tile {
      border-radius: 5px;
      background: var(--bg-tile);
      border: 2px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(11px, 2.4vw, 14px);
      font-weight: bold;
      text-transform: uppercase;
      user-select: none;
      transition: background 0.1s, border-color 0.1s, transform 0.07s ease, box-shadow 0.08s ease;
      aspect-ratio: 1 / 1;
      min-width: 22px;
    }

    .tile.empty {
      background: var(--bg-tile-empty);
      border-color: #444;
      color: #555;
    }

    .tile.center {
      border-color: var(--accent-border);
      background: #4a3b25;
      color: var(--accent-soft);
    }

    .tile.floor-current {
      box-shadow: 0 0 6px rgba(255,179,71,0.5);
    }

    .tile.floor-complete {
      background: #505050;
      border-color: #777;
    }

    /* -------- PANEL -------- */
    #panel {
      margin-top: 4px;
      border-top: 1px solid #444;
      padding-top: 10px;
      font-size: 12px;
    }

    #current-word-box {
      margin-bottom: 8px;
    }

    #input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    #input-row label {
      font-size: 11px;
      color: var(--text-soft);
    }

    #word-input {
      width: 100%;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #222;
      color: var(--text-main);
      font-size: 13px;
      font-family: "Fira Mono", Menlo, Consolas, monospace;
      letter-spacing: 1px;
      box-sizing: border-box;
    }

    #floor-letter-current {
      font-weight: 600;
      color: var(--accent-soft);
    }

    #candidate-display {
      margin-top: 4px;
      font-size: 11px;
    }

    #candidate-label {
      font-weight: 600;
      margin-right: 4px;
    }

    #candidate-word {
      font-family: "Fira Mono", Menlo, Consolas, monospace;
      letter-spacing: 2px;
      font-size: 13px;
      color: var(--accent-soft);
    }

    #pivot-info {
      margin-top: 2px;
      font-size: 10px;
      color: var(--text-muted);
    }

    #buttons {
      margin-bottom: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
      background: var(--accent);
      color: #222;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.4);
      transition: background 0.1s ease, transform 0.07s ease, box-shadow 0.07s ease;
      white-space: nowrap;
    }

    button:hover {
      background: #ffab2c;
      transform: translateY(-1px);
      box-shadow: 0 3px 7px rgba(0,0,0,0.6);
    }

    button:disabled {
      background: #555;
      color: #999;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    #message {
      min-height: 16px;
      margin-bottom: 2px;
      font-size: 11px;
      color: var(--accent-soft);
      text-align: center;
    }

    #hint-message {
      min-height: 14px;
      margin-bottom: 4px;
      font-size: 10px;
      color: var(--text-soft);
      text-align: center;
      font-style: italic;
    }

    /* -------- BALANCE -------- */
    #balance-box {
      display: flex;
      justify-content: center;
      gap: 10px;
      font-size: 11px;
      margin-bottom: 6px;
      color: var(--text-soft);
    }

    #balance-box span strong {
      color: var(--accent-soft);
    }

    #balance-status {
      font-size: 11px;
      color: var(--accent-soft);
    }

    #found-words-title {
      font-weight: 600;
      margin-top: 4px;
      margin-bottom: 4px;
      color: var(--text-soft);
      text-align: center;
      font-size: 11px;
    }

    #found-words {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
    }

    #found-words li {
      padding: 2px 6px;
      border-radius: 999px;
      background: #2f2f2f;
      border: 1px solid #555;
      font-family: "Fira Mono", Menlo, Consolas, monospace;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-main);
    }

    /* -------- LETTER BANK -------- */
    #letter-bank-container {
      margin-top: 8px;
    }

    #letter-bank-label {
      font-weight: 600;
      font-size: 11px;
      margin-bottom: 4px;
      color: var(--text-soft);
      text-align: center;
    }

    #letter-bank {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 3px;
      margin-bottom: 6px;
    }

    .bank-tile {
      width: 22px;
      height: 22px;
      border-radius: 5px;
      background: var(--bg-tile);
      border: 2px solid #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.08s, border-color 0.08s, transform 0.06s ease, box-shadow 0.06s ease;
      user-select: none;
    }

    .bank-tile:hover {
      background: #505050;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      transform: translateY(-1px);
    }

    .bank-tile.used {
      background: var(--bg-tile-empty);
      border-color: #444;
      color: #666;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    #hint {
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.5;
      text-align: left;
    }

    #hint strong {
      color: var(--accent-soft);
    }

    /* Footer */
    #footer {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #444;
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
    }

    #footer a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      margin: 0 4px;
    }

    #footer a:hover {
      text-decoration: underline;
    }

    /* Mobile tweaks */
    @media (max-width: 480px) {
      #game-container {
        padding: 14px 10px 16px;
      }
      #top-bar {
        flex-direction: column;
        align-items: stretch;
      }
      #top-right {
        align-items: flex-start;
      }
      #hint {
        font-size: 9.5px;
      }
    }
  </style>
</head>
<body>
  <!-- BRAND -->
  <div id="brand">
    <span class="brand-weave">Weave</span>
    <span class="brand-txt" id="brand-txt"></span>
  </div>

  <h1>Word Tower</h1>
  <div id="subtitle">Balance every letter around the hidden spine</div>
  <h4>7th December 2025</h4>

  <div id="game-container">
    <div id="top-bar">
      <div id="top-left">
        <div id="tower-word-label">
          Tower spine: <strong id="tower-word-value">SING</strong>
        </div>
        <div id="floor-info">
          Floor <span id="floor-number">1</span>/<span id="floor-total">4</span> –
          letter: <strong id="floor-letter">G</strong>
        </div>
      </div>
      <div id="top-right">
        <label for="level-select">Level:</label>
        <select id="level-select"></select>
        <div id="time-display">Time: 00:00</div>
      </div>
    </div>

    <div id="tower"></div>

    <div id="panel">
      <div id="current-word-box">
        <div id="input-row">
          <label>
            Word for this floor
            (<span id="floor-letter-current">G</span> must appear at least once):
          </label>
          <input id="word-input" type="text" autocomplete="off" spellcheck="false" />
        </div>

        <div id="candidate-display">
          <span id="candidate-label">Candidate:</span>
          <span id="candidate-word"></span>
          <div id="pivot-info"></div>
        </div>
      </div>

      <div id="buttons">
        <button id="submit-word-btn">Submit word</button>
        <button id="undo-btn">Undo last word</button>
        <button id="hint-btn">Hint (+3:00)</button>
        <button id="reset-game-btn">Reset game</button>
      </div>

      <div id="message"></div>
      <div id="hint-message"></div>

      <div id="balance-box">
        <span>Left: <strong id="left-total">0</strong></span>
        <span>Right: <strong id="right-total">0</strong></span>
      </div>
      <div id="balance-status"></div>

      <div id="found-words-title">Tower words used:</div>
      <ul id="found-words"></ul>

      <div id="letter-bank-container">
        <div id="letter-bank-label">
          Letter tiles (click to append, but each can only be used once overall):
        </div>
        <div id="letter-bank"></div>
      </div>

      <div id="hint">
        Rules:<br />
        • The middle column shows the <strong>spine word</strong> from top to bottom (e.g. SING, STING, STRING).<br />
        • You start from the <strong>bottom floor</strong> (last letter of the spine) and climb up to the top (first letter).<br />
        • On each floor, the <strong>floor letter</strong> (from the spine) must appear at least once in your word.<br />
        • When you submit a word:
        <br />&nbsp;&nbsp;– We take the <strong>first occurrence</strong> of the floor letter as the pivot.
        <br />&nbsp;&nbsp;– Letters <strong>before</strong> the pivot count to the <strong>left</strong>.
        <br />&nbsp;&nbsp;– Letters <strong>after</strong> the pivot count to the <strong>right</strong>.
        <br />&nbsp;&nbsp;– One pivot letter is “free” (from the spine); all other letters must come from the tile bag.<br />
        • Tiles can only be used once. If a word needs more of some letter than you have, it will be rejected.<br />
        • You can only play <strong>one word per floor</strong>, moving from bottom floor to top floor.<br />
        • You <strong>win</strong> only if:
        <br />&nbsp;&nbsp;– <strong>All tiles</strong> have been used, and
        <br />&nbsp;&nbsp;– Total letters on the <strong>left</strong> equal total letters on the <strong>right</strong>.<br />
        • Using a <strong>Hint</strong> adds <strong>+3:00</strong> to your time.<br />
        • Use <strong>Undo</strong> to revert the last word (restores tiles and re-opens that floor).<br />
        • Use the <strong>Level</strong> selector to swap between 4-letter, 5-letter, and 6-letter spine words.
      </div>
    </div>

    <!-- FOOTER LINKS TO OTHER GAMES -->
    <div id="footer">
      More from WeaveTXT:
      <a href="https://www.weavetxt.com/index.html" target="_blank" rel="noopener noreferrer">
        Swap and Weave
      </a>
      <a href="https://www.weavetxt.com/tail.html" target="_blank" rel="noopener noreferrer">
        Neighbour Tail
      </a>
      <a href="https://www.weavetxt.com/steal.html" target="_blank" rel="noopener noreferrer">
        Steal &amp; Weave
      </a>
      <a href="https://www.weavetxt.com/book/chapter1.html" target="_blank" rel="noopener noreferrer">
        Geometry of Batik
      </a>
      <a href="https://www.weavetxt.com/rgb.html" target="_blank" rel="noopener noreferrer">
        RGB
      </a>
    </div>
  </div>

  <!-- Dictionary: must define const VALID_WORDS = ["CAT","DOG",...] in UPPERCASE -->
  <script src="valid-3-6.js"></script>

  <script>
    /* --------- LOOPING TXT ANIMATION --------- */
    (function animateTXT(){
      const el = document.getElementById("brand-txt");
      const word = "TXT";
      let i = 0;
      let forward = true;

      function loop(){
        el.textContent = word.slice(0, i);

        if (forward) {
          i++;
          if (i > word.length) {
            forward = false;
            setTimeout(loop, 900);
            return;
          }
        } else {
          i--;
          if (i < 0) {
            forward = true;
            setTimeout(loop, 600);
            return;
          }
        }
        setTimeout(loop, 120);
      }

      loop();
    })();

    if (typeof VALID_WORDS === "undefined") {
      console.error("VALID_WORDS is not defined. Make sure valid-3-6.js is loaded.");
      alert("Error: valid-3-6.js not loaded or VALID_WORDS not defined.");
    }

    // --------- MULTI-LEVEL CONFIG ---------
    const LEVEL_CONFIGS = [
      {
        id: "SING",
        label: "Level 1 – 4-letter spine (SING)",
        spine: "SING",
        tileBag: ["H","A","S","R","I","N","E","G"] // removed 1 A and 1 E
      },
      {
        id: "STING",
        label: "Level 2 – 5-letter spine (STING)",
        spine: "STING",
        tileBag: ["H","A","E","A","S","R","I","N","E","G"]
      },
      {
        id: "STRING",
        label: "Level 3 – 6-letter spine (STRING)",
        spine: "STRING",
        tileBag: ["A","H","A","E","A","T","S","R","I","N","E","G"]
      }
    ];

    let currentConfigIndex = 0;

    let towerWord = "";
    let levelCount = 0;
    let levelLetters = [];
    let baseLetterBag = [];

    let towerLevels = [];   // [{ word, pivotIndex, leftCount, rightCount }]
    let currentLevel = 0;   // index from bottom
    let letterBank = [];    // [{letter, used}]
    let foundWords = [];    // [{ floorIndex, word, leftCount, rightCount }]
    let gameOver = false;
    let moveHistory = [];   // undo stack
    let totalLeft = 0;
    let totalRight = 0;

    // Timer state
    let startTime = null;
    let timePenaltySeconds = 0;
    let timerIntervalId = null;

    const towerEl = document.getElementById("tower");
    const floorNumberEl = document.getElementById("floor-number");
    const floorTotalEl = document.getElementById("floor-total");
    const floorLetterEl = document.getElementById("floor-letter");
    const floorLetterCurrentEl = document.getElementById("floor-letter-current");
    const towerWordValueEl = document.getElementById("tower-word-value");
    const levelSelectEl = document.getElementById("level-select");

    const wordInputEl = document.getElementById("word-input");
    const candidateWordEl = document.getElementById("candidate-word");
    const pivotInfoEl = document.getElementById("pivot-info");

    const messageEl = document.getElementById("message");
    const hintMessageEl = document.getElementById("hint-message");
    const foundWordsEl = document.getElementById("found-words");
    const letterBankEl = document.getElementById("letter-bank");

    const leftTotalEl = document.getElementById("left-total");
    const rightTotalEl = document.getElementById("right-total");
    const balanceStatusEl = document.getElementById("balance-status");
    const timeDisplayEl = document.getElementById("time-display");

    const submitBtn = document.getElementById("submit-word-btn");
    const resetBtn = document.getElementById("reset-game-btn");
    const undoBtn = document.getElementById("undo-btn");
    const hintBtn = document.getElementById("hint-btn");

    function setHint(text) {
      hintMessageEl.textContent = text || "";
    }

    function initLevelSelect() {
      levelSelectEl.innerHTML = "";
      LEVEL_CONFIGS.forEach((cfg, idx) => {
        const opt = document.createElement("option");
        opt.value = idx;
        opt.textContent = cfg.label;
        levelSelectEl.appendChild(opt);
      });
      levelSelectEl.value = currentConfigIndex;
    }

    levelSelectEl.addEventListener("change", () => {
      const idx = parseInt(levelSelectEl.value, 10);
      initGame(idx);
    });

    function startTimer() {
      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
      }
      startTime = Date.now();
      timePenaltySeconds = 0;
      updateTimer();
      timerIntervalId = setInterval(updateTimer, 1000);
    }

    function stopTimer() {
      if (timerIntervalId !== null) {
        clearInterval(timerIntervalId);
        timerIntervalId = null;
      }
      updateTimer(); // final update
    }

    function addTimePenalty(seconds) {
      timePenaltySeconds += seconds;
      updateTimer();
    }

    function updateTimer() {
      if (!startTime) {
        timeDisplayEl.textContent = "Time: 00:00";
        return;
      }
      const now = Date.now();
      const baseSeconds = Math.floor((now - startTime) / 1000);
      const totalSeconds = baseSeconds + timePenaltySeconds;

      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      const mm = String(minutes).padStart(2, "0");
      const ss = String(seconds).padStart(2, "0");
      timeDisplayEl.textContent = "Time: " + mm + ":" + ss;
    }

    function initGame(configIndex) {
      if (typeof configIndex === "number") {
        currentConfigIndex = configIndex;
      }
      const cfg = LEVEL_CONFIGS[currentConfigIndex];

      towerWord = cfg.spine;
      levelCount = towerWord.length;
      levelLetters = towerWord.split("").reverse(); // bottom to top
      baseLetterBag = cfg.tileBag.slice();

      towerLevels = [];
      for (let i = 0; i < levelCount; i++) {
        towerLevels.push({ word: null, pivotIndex: null, leftCount: 0, rightCount: 0 });
      }

      letterBank = baseLetterBag.map(ch => ({ letter: ch, used: false }));

      currentLevel = 0;
      foundWords = [];
      gameOver = false;
      moveHistory = [];
      totalLeft = 0;
      totalRight = 0;

      towerWordValueEl.textContent = towerWord;
      floorTotalEl.textContent = levelCount.toString();

      wordInputEl.value = "";
      candidateWordEl.textContent = "";
      pivotInfoEl.textContent = "";
      setHint("");

      renderTower();
      renderLetterBank();
      renderFoundWords();
      updateFloorInfo();
      updateBalanceUI();
      setMessage("Start at the bottom floor. Enter any valid word containing the floor letter.");
      updateButtons();

      startTimer();
    }

    function updateFloorInfo() {
      floorNumberEl.textContent = (currentLevel + 1).toString();
      floorLetterEl.textContent = levelLetters[currentLevel];
      floorLetterCurrentEl.textContent = levelLetters[currentLevel];
    }

    // Render tower and show letters from submitted words around the spine
    function renderTower() {
      towerEl.innerHTML = "";

      const cols = 5;
      towerEl.style.gridTemplateColumns = `repeat(${cols}, minmax(22px, 1fr))`;

      for (let visualRow = 0; visualRow < levelCount; visualRow++) {
        const levelIndex = levelCount - 1 - visualRow; // top visually
        const levelData = towerLevels[levelIndex];
        const floorLetter = levelLetters[levelIndex];
        const isCurrentFloor = (levelIndex === currentLevel);
        const isCompleteFloor = (levelData.word !== null);

        let word = levelData.word;
        let pivotIndex = levelData.pivotIndex;
        let leftLetters = [];
        let rightLetters = [];

        if (word && typeof pivotIndex === "number") {
          leftLetters = word.slice(0, pivotIndex).split("");
          rightLetters = word.slice(pivotIndex + 1).split("");
        }

        for (let c = 0; c < cols; c++) {
          const tile = document.createElement("div");
          tile.className = "tile";

          if (isCompleteFloor) tile.classList.add("floor-complete");
          if (isCurrentFloor) tile.classList.add("floor-current");

          let char = "";

          if (c === 2) {
            tile.classList.add("center");
            char = floorLetter;
          } else if (word && typeof pivotIndex === "number") {
            if (c === 1 && leftLetters.length >= 1) {
              // closest left letter
              char = leftLetters[leftLetters.length - 1];
            } else if (c === 0 && leftLetters.length >= 2) {
              // second closest left
              char = leftLetters[leftLetters.length - 2];
            } else if (c === 3 && rightLetters.length >= 1) {
              // closest right
              char = rightLetters[0];
            } else if (c === 4 && rightLetters.length >= 2) {
              // second closest right
              char = rightLetters[1];
            }
          }

          if (!char && c !== 2) {
            tile.classList.add("empty");
          }

          tile.textContent = char;
          towerEl.appendChild(tile);
        }
      }
    }

    function renderLetterBank() {
      letterBankEl.innerHTML = "";

      letterBank.forEach((tile, idx) => {
        const div = document.createElement("div");
        div.className = "bank-tile";
        div.textContent = tile.letter;

        if (tile.used) {
          div.classList.add("used");
        } else if (!gameOver) {
          div.addEventListener("click", () => {
            wordInputEl.value += tile.letter;
            updateCandidateDisplay();
          });
        }

        letterBankEl.appendChild(div);
      });
    }

    function renderFoundWords() {
      foundWordsEl.innerHTML = "";
      if (foundWords.length === 0) return;

      foundWords.forEach(entry => {
        const floorLetter = levelLetters[entry.floorIndex];
        const li = document.createElement("li");
        li.textContent =
          floorLetter + ":" + entry.word +
          " (L" + entry.leftCount + " / R" + entry.rightCount + ")";
        foundWordsEl.appendChild(li);
      });
    }

    function setMessage(text) {
      messageEl.textContent = text || "";
    }

    function updateButtons() {
      submitBtn.disabled = gameOver;
      resetBtn.disabled = false;
      undoBtn.disabled = (moveHistory.length === 0);
      hintBtn.disabled = gameOver;
    }

    function updateBalanceUI() {
      leftTotalEl.textContent = totalLeft.toString();
      rightTotalEl.textContent = totalRight.toString();

      if (totalLeft === 0 && totalRight === 0) {
        balanceStatusEl.textContent = "";
        return;
      }

      if (totalLeft === totalRight) {
        balanceStatusEl.textContent = "Balanced so far ✔";
      } else if (totalLeft > totalRight) {
        balanceStatusEl.textContent = "Leaning LEFT by " + (totalLeft - totalRight);
      } else {
        balanceStatusEl.textContent = "Leaning RIGHT by " + (totalRight - totalLeft);
      }
    }

    function updateCandidateDisplay() {
      let word = wordInputEl.value.toUpperCase().replace(/[^A-Z]/g, "");
      wordInputEl.value = word;
      candidateWordEl.textContent = word;

      if (!word) {
        pivotInfoEl.textContent = "";
        return;
      }

      const floorLetter = levelLetters[currentLevel];
      const idx = word.indexOf(floorLetter);
      if (idx === -1) {
        pivotInfoEl.textContent =
          'The word must contain the floor letter "' + floorLetter + '".';
        return;
      }

      const left = idx;
      const right = word.length - idx - 1;
      pivotInfoEl.textContent =
        'First "' + floorLetter + '" at position ' + (idx + 1) +
        " → left: " + left + ", right: " + right + ".";
    }

    wordInputEl.addEventListener("input", updateCandidateDisplay);

    function areAllTilesUsed() {
      return letterBank.every(t => t.used);
    }

    function submitWord() {
      if (gameOver) return;

      const floorData = towerLevels[currentLevel];
      if (floorData.word !== null) {
        setMessage("This floor already has a word. Move to the next floor.");
        return;
      }

      let word = wordInputEl.value.toUpperCase().trim();
      if (!word) {
        setMessage("Enter a word first.");
        return;
      }

      if (!Array.isArray(VALID_WORDS) || !VALID_WORDS.includes(word)) {
        setMessage('"' + word + '" is not a valid English word.');
        return;
      }

      const floorLetter = levelLetters[currentLevel];
      const pivotIndex = word.indexOf(floorLetter);
      if (pivotIndex === -1) {
        setMessage('"' + word + '" must contain the floor letter "' + floorLetter + '".');
        return;
      }

      const leftCount = pivotIndex;
      const rightCount = word.length - pivotIndex - 1;

      const tempUsed = new Array(letterBank.length).fill(false);
      const usedIndices = [];
      let ok = true;
      let errorMsg = "";

      for (let i = 0; i < word.length; i++) {
        const ch = word[i];

        if (i === pivotIndex && ch === floorLetter) {
          continue; // free pivot
        }

        let found = false;
        for (let j = 0; j < letterBank.length; j++) {
          if (!letterBank[j].used && !tempUsed[j] && letterBank[j].letter === ch) {
            tempUsed[j] = true;
            usedIndices.push(j);
            found = true;
            break;
          }
        }
        if (!found) {
          ok = false;
          errorMsg = 'Not enough "' + ch + '" tiles left to use "' + word + '".';
          break;
        }
      }

      if (!ok) {
        setMessage(errorMsg);
        return;
      }

      if (foundWords.some(entry => entry.word === word)) {
        setMessage('"' + word + '" was already used on this tower. Try another word.');
        return;
      }

      usedIndices.forEach(idx => {
        letterBank[idx].used = true;
      });

      towerLevels[currentLevel] = {
        word,
        pivotIndex,
        leftCount,
        rightCount
      };

      totalLeft += leftCount;
      totalRight += rightCount;

      foundWords.push({
        floorIndex: currentLevel,
        word,
        leftCount,
        rightCount
      });

      moveHistory.push({
        floorIndex: currentLevel,
        word,
        pivotIndex,
        leftCount,
        rightCount,
        tileIndices: usedIndices
      });

      wordInputEl.value = "";
      candidateWordEl.textContent = "";
      pivotInfoEl.textContent = "";
      setHint("");

      renderTower();
      renderLetterBank();
      renderFoundWords();
      updateBalanceUI();

      const allTiles = areAllTilesUsed();
      if (allTiles) {
        stopTimer();
        if (totalLeft === totalRight) {
          setMessage(
            'Balanced tower! All tiles used and left = right (' +
            totalLeft + '). Words: ' +
            foundWords.map(e => e.word).join(", ") + "."
          );
        } else {
          setMessage(
            'All tiles used but tower is unbalanced: left ' +
            totalLeft + " vs right " + totalRight + "."
          );
        }
        gameOver = true;
        updateButtons();
        return;
      }

      if (currentLevel < levelCount - 1) {
        currentLevel++;
        updateFloorInfo();
      }

      setMessage(
        'Accepted "' + word +
        '". Left + ' + leftCount +
        ", right + " + rightCount +
        ". Continue to the next floor."
      );
      updateButtons();
    }

    function undoLastMove() {
      if (moveHistory.length === 0) {
        setMessage("Nothing to undo.");
        return;
      }

      const lastMove = moveHistory.pop();
      const { floorIndex, word, leftCount, rightCount, tileIndices } = lastMove;

      tileIndices.forEach(idx => {
        if (letterBank[idx]) {
          letterBank[idx].used = false;
        }
      });

      towerLevels[floorIndex] = {
        word: null,
        pivotIndex: null,
        leftCount: 0,
        rightCount: 0
      };

      const pos = foundWords.findIndex(
        e => e.floorIndex === floorIndex && e.word === word
      );
      if (pos !== -1) {
        foundWords.splice(pos, 1);
      }

      totalLeft -= leftCount;
      totalRight -= rightCount;

      currentLevel = floorIndex;
      gameOver = false;

      wordInputEl.value = "";
      candidateWordEl.textContent = "";
      pivotInfoEl.textContent = "";
      setHint("");

      renderTower();
      renderLetterBank();
      renderFoundWords();
      updateFloorInfo();
      updateBalanceUI();
      updateButtons();

      setMessage('Undid "' + word + '". Floor reopened and tiles restored.');
    }

    function showHint() {
      const cfg = LEVEL_CONFIGS[currentConfigIndex];
      const floorLetter = levelLetters[currentLevel];

      // Time penalty for hint
      addTimePenalty(180);

      if (cfg.id === "SING") {
        // Bottom: G (level index 0), then N, I, S
        if (currentLevel === 0 && floorLetter === "G") {
          setHint("Hint: I am fragile, oval, and breakable. Inside me life begins.");
        } else if (currentLevel === 1 && floorLetter === "N") {
          setHint("Hint: This N word ends with a double N.");
        } else if (currentLevel === 2 && floorLetter === "I") {
          setHint("Hint: This I word can also be a polite title for a man.");
        } else if (currentLevel === 3 && floorLetter === "S") {
          setHint("Hint: This S word is what’s left after something burns in a fireplace.");
        } else {
          setHint("No extra hint for this floor. Trust your vocabulary!");
        }
      } else {
        setHint("Hint: Try any word that contains the floor letter and fits your remaining tiles.");
      }
    }

    submitBtn.addEventListener("click", submitWord);
    resetBtn.addEventListener("click", () => initGame(currentConfigIndex));
    undoBtn.addEventListener("click", undoLastMove);
    hintBtn.addEventListener("click", showHint);

    // Start
    initLevelSelect();
    initGame(currentConfigIndex);
  </script>
</body>
</html>
